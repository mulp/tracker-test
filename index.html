function testTracker(tracker) {
    return new Promise(resolve => {
        const xhr = new XMLHttpRequest();
        const trackerUrl = `https://${tracker.domain}${tracker.path}`;
        let completed = false;
        
        // Reduce timeout to make detection more precise
        const timeout = setTimeout(() => {
            if (!completed) {
                completed = true;
                resolve('blocked');
            }
        }, 1500);  // Reduced from 3000ms
        
        xhr.onreadystatechange = function() {
            if (xhr.readyState === 4 && !completed) {
                completed = true;
                clearTimeout(timeout);
                
                // More granular status checking
                if (xhr.status === 0 || xhr.status >= 400) {
                    resolve('blocked');
                } else {
                    // Additional check: verify response content
                    const contentLength = xhr.getResponseHeader('Content-Length');
                    if (!contentLength || parseInt(contentLength) === 0) {
                        resolve('blocked');
                    } else {
                        resolve('loaded');
                    }
                }
            }
        };
        
        xhr.onerror = function() {
            if (!completed) {
                completed = true;
                clearTimeout(timeout);
                resolve('blocked');
            }
        };
        
        try {
            xhr.open('GET', trackerUrl, true);
            
            // Add headers to simulate real browser behavior
            xhr.setRequestHeader('User-Agent', 'Mozilla/5.0 (iPhone; CPU iPhone OS 16_6 like Mac OS X) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/16.6 Mobile/15E148 Safari/604.1');
            xhr.setRequestHeader('Accept', 'application/javascript, */*;q=0.8');
            xhr.setRequestHeader('Accept-Language', 'en-US,en;q=0.9');
            
            // Prevent caching
            xhr.setRequestHeader('Cache-Control', 'no-cache');
            
            xhr.send();
        } catch (e) {
            if (!completed) {
                completed = true;
                clearTimeout(timeout);
                resolve('blocked');
            }
        }
    });
}

// Optional: Add more detailed logging
function runTests() {
    createTrackerElements();
    
    const results = [];
    const detailedResults = [];
    
    return Promise.all(trackers.map(async (tracker) => {
        const result = await testTracker(tracker);
        updateTrackerStatus(tracker, result);
        
        // Store detailed result for potential future debugging
        detailedResults.push({
            name: tracker.name,
            domain: tracker.domain,
            result: result,
            timestamp: new Date().toISOString()
        });
        
        results.push(result);
        
        return result;
    })).then(() => {
        updateSummary(results);
        
        // Optional: Log detailed results to console
        console.log('Detailed Tracker Test Results:', detailedResults);
        
        return results;
    });
}
